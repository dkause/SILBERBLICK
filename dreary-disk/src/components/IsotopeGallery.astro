---
import { Image } from 'astro:assets';

interface Props {
  fotos: any[]; // Replace 'any' with a more specific type if available
  allTags: Set<string>;
  isotopeOptions?: {
    layoutMode?: string;
    columnWidth?: string | number;
    gutter?: string | number;
  };
  showFilterButtons?: boolean; // New prop to control visibility of filter buttons
}

// Destructure props, providing a default value for showFilterButtons
const { fotos, allTags, isotopeOptions, showFilterButtons = true } = Astro.props;

const defaultIsotopeOptions = {
  layoutMode: 'masonry',
  masonry: {
    // columnWidth: '.masonry-sizer', // REMOVED: Isotope will now use the columnWidth from the prop directly
    gutter: 0, // Keeping as 0 as per user request for now
  },
  itemSelector: '.masonry-item',
  percentPosition: true,
  transitionDuration: '0.3s',
};

// Merge default options with props
const finalIsotopeOptions = { ...defaultIsotopeOptions, ...isotopeOptions };

// Extract columnWidth and gutter for CSS variables
// Provide fallbacks if not explicitly set in isotopeOptions
const cssColumnWidth = typeof finalIsotopeOptions.columnWidth === 'string'
  ? finalIsotopeOptions.columnWidth
  : (typeof finalIsotopeOptions.columnWidth === 'number'
    ? `${finalIsotopeOptions.columnWidth}px`
    : '20%' // Default to 20% if not specified
  );

const cssGutter = typeof finalIsotopeOptions.masonry?.gutter === 'string'
  ? finalIsotopeOptions.masonry.gutter
  : (typeof finalIsotopeOptions.masonry?.gutter === 'number'
    ? `${finalIsotopeOptions.masonry.gutter}px`
    : '0px' // Default to 0px if not specified
  );

const totalFotos = fotos.length;
---

<!--
  Conditional rendering for the filter buttons.
  The buttons will only be rendered if `showFilterButtons` is true.
  By default, `showFilterButtons` is true (see frontmatter).
  To hide the buttons, set `showFilterButtons={false}` when using <IsotopeGallery />.
-->
{showFilterButtons && (
  <div class="filter-button-group" role="group" aria-label="Image filters">
    <button class="is-checked" data-filter="*" aria-pressed="true" aria-controls="gallery-grid">show all</button>
    {
      Array.from(allTags).map((tag) => (
        <button data-filter={`.${tag}`} aria-pressed="false" aria-controls="gallery-grid">{tag}</button>
      ))
    }
  </div>
)}

<div class="gallery-container">
  <div
    id="gallery-grid"
    class="grid"
    itemscope
    itemtype="http://schema.org/ItemList"
    itemprop="mainEntityOfPage"
    data-isotope-options={JSON.stringify(finalIsotopeOptions)}
  >
    <meta itemprop="numberOfItems" content={totalFotos.toString()} />
    <div class="masonry-sizer"></div> {/* Used by Isotope for column width */}
    {fotos.map(foto => (
      <div class={`masonry-item ${foto.data.tags.join(' ')}`} itemscope itemtype="http://schema.org/ImageObject">
        <a href={foto.data.image.src} itemprop="contentUrl">
          <Image
            src={foto.data.image.src}
            alt={foto.data.image.alt}
            loading="lazy"
            itemprop="image name description"
          />
        </a>
      </div>
    ))}
  </div>
  <div class="no-results-message hidden" role="status" aria-live="polite" aria-hidden="true">
    <p>No images found for this filter.</p>
  </div>
</div>
<script src="/src/scripts/isotope-init.js"></script>
<style define:vars={{ cssColumnWidth, cssGutter }}>
  .gallery-container {
    display: block; /* Ensure it's not flex or grid */
  }

  .grid {
    /* Isotope will manage positioning, so we need position: relative */
    position: relative;
    margin: 0 auto;
    padding: 0;
    list-style: none;
    display: block; /* Ensure it's not flex or grid */
    /* Removed debugging border */
  }

  /* Masonry Sizer for responsive column width */
  .masonry-sizer {
    width: var(--cssColumnWidth); /* Use CSS variable for dynamic width */
    height: 0; /* No visual height needed */
    background-color: transparent; /* No background needed */
  }

  .masonry-item {
    /* Isotope will set left/top for positioning */
    /* Width should match masonry-sizer for single-column items */
    width: calc(var(--cssColumnWidth) - var(--cssGutter) * 2); /* Adjusted for gutter on each side */
    margin: var(--cssGutter); /* Use CSS variable for dynamic margin */
    box-sizing: border-box;
    opacity: 0; /* Hide item */
    transition: opacity 0.4s ease-in-out;
  }

  .grid.isotope-is-ready .masonry-item {
    opacity: 1;
  }

  .masonry-item img {
    display: block;
    max-width: 100%;
    height: auto;
  }

  .masonry-item figcaption {
    font-family: var(--font-sans);
    font-size: var(--step--2);
    text-align: left;
    margin-top: 0.5rem;
  }

  .masonry-item .tags {
    margin-top: 0.5rem;
  }

  .masonry-item .tag {
    display: inline-block;
    background-color: #e0e0e0;
    color: #333;
    padding: 0.2em 0.5em;
    margin-right: 0.5em;
    margin-top: 0.5em;
    border-radius: 3px;
    font-size: var(--step--2);
    font-family: var(--font-sans);
  }

  .no-results-message {
    text-align: center;
    padding: 2rem;
    font-size: var(--step-1);
    color: #555;
  }

  .hidden {
    display: none;
  }

  /* REMOVED: Responsive adjustments for masonry-item width and masonry-sizer */
  /* These will now be controlled by passing different columnWidth values from the parent component */
</style>